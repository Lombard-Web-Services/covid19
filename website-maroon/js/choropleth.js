$(function(){
//---------------------------------------
// COVID-19 WORLD MAP Choropleth     	-
//       Arithmetic Progression			-
//         Thibaut LOMBARD				-
//   contact@lombard-web-services.com  	-
//---------------------------------------
//---------GLOBAL CONFIGURATION----------
//---------------------------------------
apiURL = 'https://yourwebsite/';
foldername = "data/";
fileprefix = "map_";
numberofdays = 8;
hourofupdate = 8;
//---------------------------------------
//-------END OF GLOBAL CONFIGURATION-----
//---------------------------------------
const urlParams=new URLSearchParams(window.location.search),verif_d=urlParams.get("d");generatedaysarray=function(e,a,t){for(hourofupdates=parseInt(a),gethourtoday=(new Date).getHours(),today=new Date,dayscountobject={},t&&void 0!==t&&!1!==t&&""!==t?(firstday=t.split("-").reverse().join("-"),thedaytodayis=firstday):(gethourtoday<hourofupdates?(thedaytodayis1=today.setDate(today.getDate()-2),thedaytodayis=new Date(thedaytodayis1).toISOString().slice(0,10)):(thedaytodayis1=today.setDate(today.getDate()-1),thedaytodayis=new Date(thedaytodayis1).toISOString().slice(0,10)),firstday=thedaytodayis),dc=0;dc<e;dc++)thedaytodayisformat=new Date(thedaytodayis),daycountobjectpush=thedaytodayisformat.setDate(thedaytodayisformat.getDate()-dc),dayscountobject[dc]=new Date(daycountobjectpush).toISOString().slice(0,10);return firstdaynewdate=new Date(thedaytodayis),lastdayformat=firstdaynewdate.setDate(firstdaynewdate.getDate()-e),lastday=new Date(lastdayformat).toISOString().slice(0,10),{dayscountobject:dayscountobject,firstday:firstday,lastday:lastday}},hex=function(e){var a="0123456789abcdef",t=parseInt(e);return 0==t||isNaN(e)?"00":(t=Math.round(Math.min(Math.max(0,t),255)),a.charAt((t-t%16)/16)+a.charAt(t%16))},convertToHex=function(e){return hex(e[0])+hex(e[1])+hex(e[2])},trim=function(e){return"#"==e.charAt(0)?e.substring(1,7):e},convertToRGB=function(e){var a=[];return a[0]=parseInt(trim(e).substring(0,2),16),a[1]=parseInt(trim(e).substring(2,4),16),a[2]=parseInt(trim(e).substring(4,6),16),a},generateColor=function(e,a,t){var o=convertToRGB(e),l=convertToRGB(a),r=t+1,d=0,n=[];for(n.push(a),i=0;i<r;i++){var s=[];d+=1/r,s[0]=o[0]*d+(1-d)*l[0],s[1]=o[1]*d+(1-d)*l[1],s[2]=o[2]*d+(1-d)*l[2],n.push(convertToHex(s))}return n},nFormatter=function(e,a){var t,o=[{value:1,symbol:""},{value:1e3,symbol:"k"},{value:1e6,symbol:"M"},{value:1e9,symbol:"G"},{value:1e12,symbol:"T"},{value:1e15,symbol:"P"},{value:1e18,symbol:"E"}];for(t=o.length-1;t>0&&!(e>=o[t].value);t--);return(e/o[t].value).toFixed(a).replace(/\.0+$|(\.[0-9]*[1-9])0+$/,"$1")+o[t].symbol},arithmetic_progression_legende=function(e){for(valeurmaxi=Math.max.apply(null,e),valeurmini=Math.min.apply(null,e),nombredecouleurs=$("#legendval > div").length,$("#legendval > div:eq(0)").contents().remove(),$("#legendval > div:eq(0)").html("["+valeurmini+"]"),i=0;i<nombredecouleurs;i++)$("#legendval > div:eq("+i+")").contents().remove(),quantizer=Math.round(i*(valeurmaxi/nombredecouleurs)*10)/10,0==quantizer?$("#legendval > div:eq("+i+")").html(quantizer):$("#legendval > div:eq("+i+")").html("&#8804; &nbsp;"+nFormatter(quantizer,1));dernierid=nombredecouleurs-1,$("#legendval > div:eq("+dernierid+")").contents().remove(),$("#legendval > div:eq("+dernierid+")").html("&#8804; &nbsp;"+nFormatter(valeurmaxi,1))},tlmaps=function(e,a,t,o,l,r){$("#tlmap").vectorMap({map:"world_en",backgroundColor:"#ffffff",color:"#fff",enableZoom:!0,showTooltip:!0,showLabels:!1,scaleColors:["#F4FA1C","#691f0e"],values:e,normalizeFunction:"polynomial",onResize:function(e,a,t){}})},firstday=generatedaysarray(numberofdays,hourofupdate,verif_d).firstday,lastday=generatedaysarray(numberofdays,hourofupdate,verif_d).lastday,alldaysarray=generatedaysarray(numberofdays,hourofupdate,verif_d).dayscountobject,alldaysarraystr=JSON.stringify(alldaysarray),datetofn=generatedaysarray(numberofdays,hourofupdate,verif_d).firstday,apiurl=apiURL+foldername+fileprefix+datetofn+".json",console.log("getting data from : "+apiurl),recuptableau=function(e){return $.getJSON(e,function(e){})},buildjsondata=function(e,a,t){var o={};for([keyd,valued]of Object.entries(e))0==keyd?metareq={days:valued.days,count:valued.count,baserowcount:valued.baserowcount}:(secondkeysplitted=keyd.split("."),t==secondkeysplitted[0]&&("undefined"==secondkeysplitted[1]?(notdefined="notdefined",o[notdefined]=valued[a]):o[secondkeysplitted[1]]=valued[a]));return{example_data:o,metareq:metareq}},tableauajax=recuptableau(apiurl),tableauajax.done(function(e){for(cor in Meta=buildjsondata(e,"Deaths",firstday).metareq,Deaths=buildjsondata(e,"Deaths",firstday).example_data,Recovered=buildjsondata(e,"Recovered",firstday).example_data,Active=buildjsondata(e,"Active",firstday).example_data,Confirmed=buildjsondata(e,"Confirmed",firstday).example_data,Country_Region=buildjsondata(e,"Country_Region",firstday).example_data,example_datatoarray=$.map(Deaths,function(e,a){return[e]}),arithmetic_progression_legende(example_datatoarray),tmpcolor=generateColor("#691f0e","#F4FA1C",4),tmpcolor)$("#legendcolor"+cor).css("background-color","#"+tmpcolor[cor]);tlmaps(Deaths,Deaths,Recovered,Active,Confirmed,Country_Region),jQuery("#tlmap").bind("labelShow.tlmaps",function(e,a,t){htmllabel='<div class="tlmaps-labelcontainer">',htmllabel+='<div class="tlmaps-labelflag">',htmllabel+=' <a class="f32"><i class="flag '+t.toLowerCase()+'"></i></a>',htmllabel+="</div>",htmllabel+='<div class="tlmaps-label-table">',htmllabel+='<table class="tlmaps-label-table"><tbody width="100%">',htmllabel+="<tr>",htmllabel+='<th colspan="2" style="text-align:center">'+Country_Region[t]+"</th>",htmllabel+="</tr>",htmllabel+="<tr>",htmllabel+="<td>Confirmed</td>",htmllabel+="<td>"+Confirmed[t]+"</td>",htmllabel+="</tr>",htmllabel+="<tr>",htmllabel+="<td>Deaths</td>",htmllabel+="<td>"+Deaths[t]+"</td>",htmllabel+="</tr>",htmllabel+="<tr>",htmllabel+="<td>Recovered</td>",htmllabel+="<td>"+Recovered[t]+"</td>",htmllabel+="</tr>",htmllabel+="<tr>",htmllabel+="<td>Active</td>",htmllabel+="<td>"+Active[t]+"</td>",htmllabel+="</tr>",htmllabel+="</table></tbody>",htmllabel+="</div>",htmllabel+="</div>",a.html(""),a.append(htmllabel)}),$("#changeset").click(function(){jQuery("#tlmap").vectorMap("set","normalizeFunction","polynomial")}),$("#changesetlin").click(function(){jQuery("#tlmap").vectorMap("set","normalizeFunction","linear")}),$(".middle").css({bottom:"15em",left:"1em"}),$(".right").css({bottom:"8.5em",left:"1em",position:"absolute"}),$(".left").css({bottom:"1em",left:"1em"}),$(".middle").draggable({create:function(e,a){$(this).css({top:$(this).position().top,bottom:"auto"})},scroll:!1,opacity:.35}),$(".right").draggable({create:function(e,a){$(this).css({top:$(this).position().top,bottom:"auto"})},scroll:!1,opacity:.35}),$(".left").draggable({create:function(e,a){$(this).css({top:$(this).position().top,bottom:"auto"})},scroll:!1,opacity:.35}),$("[id^=atoggle]").click(function(){theliid=$(this).attr("id"),theclassto=theliid.split("atoggle"),theclasstotoggle="li"+theclassto[1],$("."+theclasstotoggle).toggle(),"â–²"==$(this).text()?$(this).html("&#x25BC;"):$(this).html("&#x25B2;")}),$("#myRange").on("input",function(){for(cor in $("#nbdays").html($(this).val()),specificday=$(this).val(),specificoption=$('input[name="radio"]:checked').val(),Deaths=buildjsondata(e,"Deaths",alldaysarray[specificday]).example_data,Recovered=buildjsondata(e,"Recovered",alldaysarray[specificday]).example_data,Active=buildjsondata(e,"Active",alldaysarray[specificday]).example_data,Confirmed=buildjsondata(e,"Confirmed",alldaysarray[specificday]).example_data,Country_Region=buildjsondata(e,"Country_Region",alldaysarray[specificday]).example_data,example_datatoarray=$.map(window[specificoption],function(e,a){return[e]}),arithmetic_progression_legende(example_datatoarray),tmpcolor=generateColor("#691f0e","#F4FA1C",4),tmpcolor)$("#legendcolor"+cor).css("background-color","#"+tmpcolor[cor]);jQuery("#tlmap").vectorMap("set","values",window[specificoption])}),$("input[name=radio]").change(function(){for(cor in specificoption=$("input[name=radio]:checked").val(),specificday=$("#myRange").val(),Deaths=buildjsondata(e,"Deaths",alldaysarray[specificday]).example_data,Recovered=buildjsondata(e,"Recovered",alldaysarray[specificday]).example_data,Active=buildjsondata(e,"Active",alldaysarray[specificday]).example_data,Confirmed=buildjsondata(e,"Confirmed",alldaysarray[specificday]).example_data,Country_Region=buildjsondata(e,"Country_Region",alldaysarray[specificday]).example_data,example_datatoarray=$.map(window[specificoption],function(e,a){return[e]}),arithmetic_progression_legende(example_datatoarray),tmpcolor=generateColor("#691f0e","#F4FA1C",4),tmpcolor)$("#legendcolor"+cor).css("background-color","#"+tmpcolor[cor]);jQuery("#tlmap").vectorMap("set","values",window[specificoption])}),$("#srcdata").text("Source: Johns Hopkins CSSE , Data Since "+firstday+" on "+Meta.days+" days ("+Meta.count+" records)")});
});
